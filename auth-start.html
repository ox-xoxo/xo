<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Teams SSO 弹窗登录</title>
  <script src="https://alcdn.msauth.net/browser/2.44.0/js/msal-browser.min.js"></script>
</head>
<body>
<script>
  const msalConfig = {
    auth: {
      clientId: "42f4bbec-a063-4b3d-ae19-7c4ef55c8f53", // Azure AD 客户端 ID
      authority: "https://login.microsoftonline.com/91f83333-a9da-4276-9b76-41926761614e",
      redirectUri: window.location.origin + "/auth-end.html"
    }
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const loginRequest = { scopes: ["User.Read"] };

  // 登录并获取 token
  msalInstance.loginPopup(loginRequest)
    .then(loginResponse => {
      return msalInstance.acquireTokenSilent(loginRequest)
        .catch(() => msalInstance.acquireTokenPopup(loginRequest));
    })
    .then(tokenResponse => {
      // 返回 token 给 Teams 弹窗
      if (window.opener) {
        window.opener.postMessage({ status: "success", token: tokenResponse.accessToken }, "*");
        window.close();
      } else if (window.parent !== window) {
        window.parent.postMessage({ status: "success", token: tokenResponse.accessToken }, "*");
      }
    })
    .catch(err => {
      if (window.opener) {
        window.opener.postMessage({ status: "failure", error: err }, "*");
        window.close();
      } else if (window.parent !== window) {
        window.parent.postMessage({ status: "failure", error: err }, "*");
      }
    });
</script>
</body>
</html>
